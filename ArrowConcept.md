# Введение #

Данная задача составляет неотъемлемую часть проекта и является довольно сложной в реализации.
В частности, в проекте необходимо реализовать:


  1. Добавление стрелки. Оно должно проверять, если щелчок на добавление, происходил внутри блока, то к какому краю оно ближе (определение по треугольника блока), проверку выполняется ли условие того, что в данную сторону не входит более трех стрелок. При отрисовке, помимо проверки на пересечение с блоком, должно проверяться, условие завершения работы, а при добавлении в финальный блок - проверка на количество. И если клик произошёл по сегменту стрелки, то сегмент декомпозируется на два в разбиваемой точке
  1. "Дорисовка" стрелки. Когда стрелка существует, можно кликнуть на один из краёв её и дорисовать недостающие сегменты. В принципе, данное действие должно быть подобно предыдущему, за исключением того, что не создаётся новой стрелки.
  1. Удаление сегмента стрелки. При удалении сегмента стрелки, теперь необходимо учитывать связи сегмента, в частности, если появляется "висячая" точка, которая не имеет связей, то она удаляется. Также, со стрелками (а конкретно с точками) могут быть связаны линии аннотации, которые при висячей точке надо удалять. В таком случае, пользователю при удалении необходимо вывести сообщение о том, что удаление сегмента приведёт к удалению линии аннотации. Кроме этого, если у точки есть входы  но нет выходов и входов более двух, то эту точку необходимо разбить на две, т.к. это может вести к странным последствиям.
  1. Перемещение блока. При перемещении блока теперь необходимо учитывать не только пересечение, но и количество и тип стрелок, которые окажутся рядом и на основе этого определить, корректно ли перемещение. Если перемещение некорректно, то производится откат данного события.
  1. Перемещение сегмента стрелки. При перемещении сегмента стрелки требуется чтобы он перемещался по оси перпендикулярной сегменту и в рамках того, что ориентация по оси смежных сегментов при такой позиции не изменялась. Кроме того, перемещение сегмента невозможно, если следующий или предыдущий сегмент имеют ту же самую ориентацию (т.е. происходила декомпозия с использованием линии аннотации)
  1. Добавление линии аннотации. Происходит с декомпозицией сегмента стрелки.


# Реализация #

Для реализации предлагается следующая модель работы.

1. Вводится расширенный класс "Точка", содержащий в себе, помимо координат, ссылки на связанные сегменты, а также линии аннотации. Также он должен содержать диаграмму.

2. Вводится расширенный класс "Сегмент", содержащий в себе указатели на точки и диаграмму. Кроме того, он является графическим объектом, поэтому он содержит так же и сцену.

Все данные объекты, а также линия аннотации реализуют метод die(), который удаляет их из диаграммы и сцены. Кроме того, в случае точек, диаграмма освобождает память из-под них.

Как это выглядит в памяти (приблизительно):
![http://dl.dropbox.com/u/5039908/arrowmodel.png](http://dl.dropbox.com/u/5039908/arrowmodel.png)
(Картинку в будущем стоит переделать, однако она отражает ссылки)

Для реализации этого стоит ввести следующую процедуру:
определение позиции к какой стороне относится точка.
Это легко определить, если
ввести замену:

a=(x-x0)/width\*2, ), b=(y-y0)/height\*2, где x,y - исходная точка
x0,y0 - точка середины прямоугольника, width и  height - ширина и высота данного блока.

Тогда:

1. Если |a|>|b| и a<0 - сторона - левая, иначе если a>0 - сторона правая

2. Если |b|>|a| и b<0 - сторона - верхняя, иначе нижняя

# Сохранение и загрузка данных структур #

Для загрузки, в начале нужно построить хештаблицу отображений адреса памяти на объект. Всего три таблицы - точки, сегменты, линии аннотации. Затем, в следующем проходе уже проставлять все ссылки.
На третьем проходе добавить все объекты внутри сцены.

# Данный документ является незаконченным #
Его необходимо дополнить алгоритмами.
# Введение #

Данный документ описывает то, в каком формате будет сохраняться файл и как он будет загружаться.


# Основные методы описания #

Строковые значения будут записываться в прямом виде, с заменой следующих сущностей (экранирование, на данный момент осуществляется самим Qt и заменяются только ",&,<):

| " |	 &quot; |
|:--|:--------|
| ' |	 &apos; |
| & |	 &amp;  |
| < |	 &lt;   |
| > |	 &gt;   |
| \n | &#10; |


Целочисленные значения и символы, а также значения с плавающей точкой отображаются в строку и записываются без изменений.

Указатели отображаются как числа в шестнадцатеричном виде.

Точка (QPointF) отображается, как строка   вида "<X координата>;<Y координата>"

Прямоугольник (QRectF) отображается, как строка вида "<X координата>;<Y координата>;<Длина>;<Высота>", где внутренние параметры - прямое отображение числа с плавающей точкой в строку.

Прямоугольник (QRect) отображается, как строка вида "<X координата>;<Y координата>;<Длина>;<Высота>", где внутренние параметры - прямое отображение целого числа в строку.

# Описание блока #

Описание блока состоит из следующего тега со следующими аттрибутами:

| 

<block this="указатель на себя" real\_string="реальный текст блока" viewed\_string="отображаемый текст блока" string\_pos="прямоугольник, в который вписывается текст" number\_pos="позиция номера текста" rect="прямоугольник, который описывает границы блока" id="Идентификатор блока" childid="ID дочерней диаграммы">



&lt;/block&gt;

 |
|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

Внутри блока имеются следующие сущности
|  

&lt;ptr value="указатель на прикрепленный сегмент стрелки"&gt;



&lt;/ptr&gt;

  |
|:---------------------------------------------------------------------------------------------------------------------------|

NULL указывает, что никакой сегмент не прикреплен. Также они записаны строго в порядке следования сторон и в порядке увеличения номера ссылки.

# Описание надписи аннотации #

Описание надписи аннотации состоит из следующего тега со следующими атрибутами:

| 

<annotation\_label string="текст надписи аннотации" rect="прямоугольник, описывающий границу надписи">



</annotation\_label>

 |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

# Описание линии аннотации #

Описание линии аннотации может производиться в следующих видах.
Если линия прикреплена к сегменту стрелки, то объявление выглядит как

| 

<annotation\_line this="указатель на себя" binded="true" binded\_ptr="указатель на точку, к которой прикреплена линия" free="координаты второй точки">



</annotation\_line>

 |
|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

Иначе:

| 

<annotation\_line this="указатель на себя" binded="false" coords="координаты первой точки" free="координаты второй точки">



</annotation\_line>

 |
|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

# Описание сегмента стрелки #

Описание сегмента производится в следующем формате:

| 

&lt;segment  this="указатель на себя" in="указатель на точку, описывающую вход" out="указатель на точку, описывающую выход"&gt;



&lt;/segment&gt;

 |
|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

# Описание точки стрелки #

Описание точки стрелки производится в следующем формате

| 

&lt;point this="указатель на себя" x="координата по оси х" y="координата по оси y" block="идентификатор блока к которому прикреплена"&gt;



&lt;/point&gt;

 |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

Внутри описания точки содержаться следующие определения

| 

&lt;in ptr="указатель на входной сегмент"&gt;



&lt;/in&gt;

 |
|:------------------------------------------------------------------------------------------|
| 

&lt;out ptr="указатель на выходной сегмент"&gt;



&lt;/out&gt;

 |
| 

&lt;line ptr="указатель на линию аннотации"&gt;



&lt;/line&gt;

 |

# Описание диаграммы #

Содержит все предыдущие определения, однако сама определяется как:

| 

&lt;diagram  id="Индентификатор диаграммы" location="номер родительской диаграммы;номер блока"&gt;



&lt;/diagram&gt;

 |
|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

# Набор диаграмм #

Описывается как:

| 

&lt;set maxid="число диаграмм"&gt;



&lt;/set&gt;

 |
|:--------------------------------------------------------------------|

# Сохранение #

Не представляет проблем - данная архитектура представима в виде дерева в итоге мы можем последовательно пройтись по архитектуре и сохранить всё в вершины.

# Загрузка #

Используется следующая структура:

  1. Указатель на текущий набор диаграмм.
  1. Указатель на текущую диаграмму
  1. Указатель на текущий блок
  1. Указатель на текущую точку сегмента
  1. Указатель на текщую  сцену
  1. Хеш  указатель -> блок
  1. Хеш  указатель -> линия аннотации
  1. Хеш  указатель -> сегмент
  1. Хеш  указатель -> точка

На данном этапе разработки работа алгоритма строится следующим образом:

  1. Сначала заполняется максимальное число диаграмм
  1. Затем для каждой диаграммы устанавливается ID и она устанавливается в поле.
  1. В эту диаграмму добавляются все объекты и заполняются хеши их отображения (поля 5-8 структуры). Их поля-указатели устанавливаются в неправильные значения указателей (т.е. то, что было в файле)
  1. По всем объектам диаграммы производится цикл исправления указателей (поля 5-8 структуры)
  1. Объекты диаграммы добавляются в сцену
  1. Обновляется сцена